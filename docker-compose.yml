services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: laravel
        environment:
            - APP_ENV=local
            - APP_DEBUG=true
            - DB_CONNECTION=mongodb
            - DB_HOST=mongodb
            - DB_PORT=27018
            - ELASTICSEARCH_HOST=elasticsearch
            - ELASTICSEARCH_PORT=9200
        volumes:
            - .:/var/www
        networks:
            - es-net
        depends_on:
            - mongodb
            - elasticsearch

    nginx:
        image: nginx:alpine
        container_name: nginx
        ports:
            - "8080:80"
        volumes:
            - ./nginx/conf.d/:/etc/nginx/conf.d/
            - .:/var/www
        depends_on:
            - app
        networks:
            - es-net

    # MongoDB Service
    mongodb:
        image: mongo:latest
        container_name: mongodb
        environment:
            - MONGO_INITDB_ROOT_USERNAME=root
            - MONGO_INITDB_ROOT_PASSWORD=123456
        volumes:
            - mongodb_data:/data/db
        networks:
            - es-net
        ports:
            - "27018:27017"

    # Elasticsearch Service
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
        container_name: elasticsearch
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - es_data:/usr/share/elasticsearch/data
        networks:
            - es-net
        ports:
            - "9200:9200"
            - "9300:9300"

    # Kibana Service
    kibana:
        image: docker.elastic.co/kibana/kibana:8.15.2
        container_name: kibana
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        depends_on:
            - elasticsearch
        ports:
            - "5601:5601"
        volumes:
            - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml
        networks:
            - es-net

    # Logstash Service
    logstash:
        image: docker.elastic.co/logstash/logstash:8.15.2
        container_name: logstash
        volumes:
            - ./logstash/pipeline:/usr/share/logstash/pipeline
        ports:
            - "5044:5044"
            - "5000:5000"
            - "9600:9600"
        depends_on:
            - elasticsearch
        networks:
            - es-net

# Volumes
volumes:
    mongodb_data:
    es_data:

# Networks
networks:
    es-net:
        driver: bridge
